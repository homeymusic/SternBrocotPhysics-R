---
title: "Stern-Brocot Physics"
output:
  github_document: default
---

# Smoke Test: Quantum Harmonic Oscillator Analysis

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(ggplot2)
library(patchwork)
library(data.table)
library(tidyr)

# Configured for 2026 SanDisk4TB Volume paths
base_dir <- "/Volumes/SanDisk4TB/SternBrocot/02_quantum_harmonic_oscillator"
hist_dir <- file.path(base_dir, "histograms")
summary_file <- file.path(base_dir, "02_quantum_harmonic_oscillator.csv.gz")

# Helper to locate specific histogram files
get_histogram_path <- function(p_val) {
  file.path(hist_dir, sprintf("histogram_P_%013.6f.csv.gz", round(p_val, 6)))
}

if (!file.exists(summary_file)) {
  stop("Summary file not found at: ", summary_file)
}

# Load the smoke test results
dt_summary <- data.table::fread(summary_file)
```

## 1. Physical Quantization: Nodes vs. Momentum
This plot verifies the relationship between the momentum ($P$) and the number of detected physical nodes.

```{r plot-nodes, fig.width=10, fig.height=5}
ggplot(dt_summary[!is.na(node_count)], aes(x = normalized_momentum, y = node_count)) +
  geom_step(color = "red", linewidth = 1, alpha = 0.7) +
  geom_point(color = "black", size = 1.5) +
  labs(
    title = "Node Count vs. Momentum",
    subtitle = "Step function behavior indicates quantization levels",
    x = "Normalized Momentum (P)",
    y = "Detected Nodes"
  ) +
  theme_minimal(base_family = "mono")
```
## 2. Program Length Statistics (Consolidated)
Analysis of program lengths showing the central tendency (Mean/Median) and the dispersion (±1 SD Ribbon).

```{r plot-stats-consolidated, fig.width=10, fig.height=6}
# We use the summary data directly since mean, median, and sd are separate columns
ggplot(dt_summary, aes(x = normalized_momentum)) +
  # 1. Standard Deviation Ribbon
  geom_ribbon(aes(ymin = program_length_mean - program_length_sd, 
                  ymax = program_length_mean + program_length_sd, 
                  fill = "±1 SD Range"), 
              alpha = 0.15) +
  
  # 2. Mean Line
  geom_line(aes(y = program_length_mean, color = "Mean"), linewidth = 0.7) +
  
  # 3. Median Line
  geom_line(aes(y = program_length_median, color = "Median"), linewidth = 1.1) +
  
  # Aesthetics and Labels
  scale_fill_manual(name = "Dispersion", values = c("±1 SD Range" = "gray20")) +
  scale_color_manual(name = "Metrics", values = c("Mean" = "blue", "Median" = "darkgreen")) +
  labs(
    title = "Program Length Distributions",
    subtitle = "Combined Mean, Median, and Standard Deviation Ribbon",
    x = "Normalized Momentum (P)",
    y = "Program Length (bits)"
  ) +
  theme_minimal(base_family = "mono") +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )
```

## 3. Node Detection Audit (Histograms)
Verification of tracked minima (red dots) and central trough correction ($x=0$).

```{r generate-grid, fig.width=12, fig.height=25}
target_p <- dt_summary$normalized_momentum

# Generate individual plots for the patchwork grid
plot_list <- lapply(target_p, function(p) {
  f_path <- get_histogram_path(p)
  
  if (file.exists(f_path)) {
    d_temp <- data.table::fread(f_path)
    h_pts <- d_temp[type == "hist"]
    n_pts <- d_temp[type == "node"]
    node_count_val <- d_temp$node_count[1]
    
    bw <- if(nrow(h_pts) > 1) diff(h_pts$x[1:2]) else 0.1

    ggplot(h_pts, aes(x, y)) +
      geom_col(fill = "black", alpha = 0.2, width = bw) +
      # Red points verify the new C++ tracked y-minima logic
      geom_point(data = n_pts, aes(x, y), color = "red", size = 1.5, shape = 16) +
      labs(
        title = paste0("P = ", round(p, 2)),
        subtitle = paste0("Nodes: ", node_count_val),
        x = "q", y = ""
      ) +
      theme_minimal(base_family = "mono") +
      theme(
        plot.title = element_text(size = 9, face = "bold"),
        plot.subtitle = element_text(size = 8, color = "blue"),
        axis.text = element_text(size = 7),
        panel.grid.minor = element_blank()
      )
  } else {
    ggplot() + theme_void() + labs(title = paste("Missing:", p))
  }
})

# Combine plots into a 4-column grid
patchwork::wrap_plots(plot_list, ncol = 4) + 
  patchwork::plot_annotation(
    title = "Node Detection Smoke Test (40 Targets)",
    subtitle = "Red dots: Verified minima | SanDisk4TB Source",
    theme = theme(plot.title = element_text(size = 18, face = "bold", family = "mono"))
  )
```
