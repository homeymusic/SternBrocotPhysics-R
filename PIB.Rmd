---
title: "Particle in a Box - Coordinate Distributions"
output:
  github_document: default
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(fig.showtext = TRUE, dpi = 300)
library(ggplot2)
library(patchwork)
library(dplyr)
library(tidyr)
library(data.table)
```

```{r build-and-load, echo=F, message=F, include=F}
pkgbuild::compile_dll() 
devtools::load_all(".")

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/PIB-",
  warning = FALSE,
  message = FALSE,
  fig.crop = TRUE
)
manuscript_dir <- here::here("manuscript")
```

```{r helper-functions, echo=FALSE}
# --- HELPER FUNCTIONS FOR PIB ---

# File path helper
get_histogram_path <- function(momentum_val) {
  here::here("data-raw", "outputs", "03_particle_in_a_box", "histograms", 
             sprintf("histogram_P_%013.6f.csv.gz", round(momentum_val, 6)))
}

# Standardized save function
save_plot <- function(plot_obj, filename, width = 10, height = 6) {
  ggplot2::ggsave(
    filename = file.path(manuscript_dir, filename),
    plot = plot_obj, 
    width = width, 
    height = height,
    device = grDevices::cairo_pdf,
    limitsize = FALSE
  )
}

# Data preparation helper
prepare_plot_data <- function(dt_summary) {
  plot_data <- dt_summary[max_momentum > 0.0, .(
    p_val = as.numeric(max_momentum), 
    nodes = as.numeric(node_count)
  )]
  # PIB eigenstates: n = floor(P/pi) for sine waves in box
  plot_data[, is_eigenstate := (floor(p_val / pi) == nodes)]
  return(plot_data)
}

# Median selection helper
get_median_by_nodes <- function(dt, node_col = "nodes", p_col = "p_val") {
  data.table::setorderv(dt, c(node_col, p_col))
  dt[dt[, .I[floor((.N+1)/2)], by = node_col]$V1][, 
     .(n = nodes, momentum = p_val)]
}
```

```{r load-data, echo=FALSE}
summary_path <- here::here("data-raw", "outputs", "03_particle_in_a_box", "03_aggregated_summary.csv.gz")
dt_summary <- data.table::fread(summary_path)
data.table::setorder(dt_summary, max_momentum)
dt_summary <- dt_summary[max_momentum > 0.0]

# Detect complexity transitions
z_diffs <- abs(diff(dt_summary$kolmogorov_complexity_median))
threshold <- max(z_diffs, na.rm = TRUE) * 0.0001
jump_indices <- which(z_diffs > threshold)

jumps <- lapply(seq_along(jump_indices), function(i) {
  idx <- jump_indices[i]
  m_at <- dt_summary$max_momentum[idx + 1]
  list(
    n = paste("Transition", i),
    p_vals = c(m_at-1, m_at, m_at+1)
  )
})

p_markers <- dt_summary$max_momentum[jump_indices]
```

# Particle in a Box Analysis

The particle in a box has a fixed spatial extent L=1, but momentum can increase indefinitely. Unlike the quantum harmonic oscillator where both P and Q scale together, here the coordinate remains bounded while momentum grows.

## Complexity vs Momentum

```{r complexity-plot, echo=FALSE, fig.width=12, fig.height=6}
plot_dt_p <- dt_summary[max_momentum > 0.0, .(
  p_val = as.numeric(max_momentum),
  y_mean = as.numeric(kolmogorov_complexity_mean),
  y_med = as.numeric(kolmogorov_complexity_median),
  y_sd = as.numeric(kolmogorov_complexity_sd)
)]

p_complexity <- ggplot(plot_dt_p, aes(x = p_val)) +
  geom_vline(xintercept = p_markers, color = "grey80", linetype = "dashed", alpha = 0.5) +
  geom_ribbon(aes(ymin = y_mean - y_sd, ymax = y_mean + y_sd), fill = "gray50", alpha = 0.1) +
  geom_line(aes(y = y_mean, color = "Mean"), linewidth = 0.6) +
  geom_line(aes(y = y_med, color = "Median"), linewidth = 1.0) +
  scale_color_manual(values = c("Mean" = "gray60", "Median" = "black")) +
  labs(
    title = "PIB: Kolmogorov Complexity vs. Momentum",
    x = "Momentum P [p/p_0]",
    y = "Complexity [bits]",
    color = "Series"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

print(p_complexity)
save_plot(p_complexity, "pib_complexity.pdf", width = 12, height = 6)
```

## Node Count vs Momentum

```{r node-count-plot, echo=FALSE, fig.width=10, fig.height=6}
plot_nodes_p <- dt_summary[max_momentum > 0.0, .(
  p_val = as.numeric(max_momentum),
  nodes = as.numeric(node_count)
)]

p_nodes <- ggplot(plot_nodes_p, aes(x = p_val, y = nodes)) +
  geom_vline(xintercept = p_markers, color = "grey80", linetype = "dashed", alpha = 0.5) +
  geom_point(size = 0.3, alpha = 0.6, color = "black") +
  labs(
    title = "PIB: Node Counts vs. Momentum",
    x = "Momentum P [p/p_0]",
    y = "Node Count"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

print(p_nodes)
save_plot(p_nodes, "pib_nodes.pdf", width = 10, height = 6)
```

## Eigenstate Identification

```{r eigenstates-plot, echo=FALSE, fig.width=10, fig.height=6}
plot_nodes_p <- prepare_plot_data(dt_summary)

p_eigenstates <- ggplot(plot_nodes_p, aes(x = p_val, y = nodes)) +
  geom_point(color = "grey70", size = 0.2, alpha = 0.4) +
  geom_vline(xintercept = p_markers, color = "grey80", linetype = "dashed", alpha = 0.5) +
  geom_point(data = plot_nodes_p[is_eigenstate == TRUE], color = "red", size = 0.4) +
  labs(
    title = "PIB: Eigenstates (red) Among All Configurations",
    subtitle = "For particle in a box with L=1, eigenstates follow n = floor(P/Ï€)",
    x = "Momentum P [p/p_0]",
    y = "Node Count",
    caption = "Red: Eigenstates | Grey: All Configurations"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    plot.subtitle = element_text(hjust = 0.5, size = 10, face = "italic")
  )

print(p_eigenstates)
save_plot(p_eigenstates, "pib_eigenstates.pdf", width = 10, height = 6)
```

## Sample Coordinate Distributions

```{r sample-distributions, echo=FALSE, fig.width=10, fig.height=12}
# Select a range of momentum values to visualize
sample_momenta <- dt_summary[seq(1, nrow(dt_summary), length.out = min(12, nrow(dt_summary))), max_momentum]

plot_list <- vector("list", length(sample_momenta))

for (i in seq_along(sample_momenta)) {
  p_val <- sample_momenta[i]
  f_path <- get_histogram_path(p_val)
  
  if (file.exists(f_path)) {
    d_temp <- fread(f_path)
    h_pts <- d_temp[type == "hist"]
    n_pts <- d_temp[type == "node"]
    node_count <- d_temp$node_count[1]
    
    plot_list[[i]] <- ggplot(h_pts, aes(x, y)) +
      # Use geom_area and geom_line for a smoother visual representation
      # This connects midpoints, blurring high frequencies into the classical uniform PDF
      geom_area(fill = "steelblue", alpha = 0.3) +
      geom_line(color = "steelblue", linewidth = 0.5) +
      geom_point(data = n_pts, size = 1.5, shape = 16, color = "red") +
      labs(
        title = sprintf("P=%.2f | n=%d", p_val, node_count),
        x = "q [position in box]", 
        y = "counts"
      ) +
      theme_minimal(base_family = "mono") +
      theme(plot.title = element_text(size = 9))
  } else {
    plot_list[[i]] <- ggplot() + 
      theme_void() +
      labs(title = sprintf("P=%.2f missing", p_val))
  }
}

combined <- patchwork::wrap_plots(plot_list, ncol = 3) +
  patchwork::plot_annotation(
    title = "Particle in a Box: Coordinate Distributions at Various Momenta",
    subtitle = "Fixed box length L=1, increasing momentum P"
  )

print(combined)
save_plot(combined, "pib_distributions_sample.pdf", width = 10, height = 12)

```

## Low vs High Momentum Comparison

```{r low-high-comparison, echo=FALSE, fig.width=12, fig.height=4}
# Compare low, medium, and high momentum states
low_p <- dt_summary[1, max_momentum]
mid_p <- dt_summary[nrow(dt_summary) %/% 2, max_momentum]
high_p <- dt_summary[nrow(dt_summary), max_momentum]

compare_momenta <- c(low_p, mid_p, high_p)
compare_plots <- vector("list", 3)

for (i in 1:3) {
  p_val <- compare_momenta[i]
  f_path <- get_histogram_path(p_val)
  
  if (file.exists(f_path)) {
    d_temp <- fread(f_path)
    h_pts <- d_temp[type == "hist"]
    n_pts <- d_temp[type == "node"]
    node_count <- d_temp$node_count[1]
    # No longer need bw for geom_line/geom_area
    # bw <- if(nrow(h_pts) > 1) diff(h_pts$x[1:2]) else 0.1
    
    compare_plots[[i]] <- ggplot(h_pts, aes(x, y)) +
      # Use geom_area and geom_line here as well
      geom_area(fill = "steelblue", alpha = 0.3) +
      geom_line(color = "black", linewidth = 0.5) +
      geom_point(data = n_pts, size = 2, shape = 16, color = "red") +
      labs(
        title = sprintf("P=%.2f (n=%d)", p_val, node_count),
        x = "q", 
        y = ""
      ) +
      theme_minimal(base_family = "mono") +
      theme(plot.title = element_text(size = 10, face = "bold"))
  }
}

comparison <- patchwork::wrap_plots(compare_plots, ncol = 3) +
  patchwork::plot_annotation(
    title = "PIB: Low, Medium, and High Momentum States",
    subtitle = "Note: coordinate range remains fixed at box length L=1"
  )

print(comparison)
save_plot(comparison, "pib_momentum_comparison.pdf", width = 12, height = 4)
```
