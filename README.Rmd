---
title: "Stern-Brocot Physics: Parabola-Matched Scan"
output:
  github_document: default
---

# Stern-Brocot Physics

![The Golden Universe](man/figures/hero_bell.png)

---

## 1. Summary: Node Count Evolution (Parabola-Matched)

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(fig.showtext = TRUE, dpi = 300)
library(ggplot2)
library(data.table)
```

```{r load-data, echo=F, message=F}
# Path Configuration
base_dir     <- "/Volumes/SanDisk4TB/SternBrocot-data"
summary_path <- file.path(base_dir, "04_erasure_distance_summary.csv.gz")
agg_dir      <- file.path(base_dir, "02_erasure_distance_densities")
nodes_dir    <- file.path(base_dir, "03_erasure_distance_density_nodes")

# Load Summary
dt_summary <- data.table::fread(summary_path)

# Handle NAs immediately
dt_summary[is.na(node_count), node_count := 0]

# --- CSV Export Logic ---
# Export all data for Node Counts <= 10 and Momentum <= 65
dt_export <- dt_summary[node_count <= 10 & normalized_momentum <= 65]
fwrite(dt_export, "~/Desktop/stern_brocot_nodes_0-10_P_le_65.csv")

# --- SELECTION LOGIC: PARABOLA MATCHING ---
# We want to find the data point closest to the ideal theoretical parabola.
# Parabola Definition:
#   Vertex: n=0 at P=3
#   Rim:    n=10 at P=33
# Equation: n = k * (P - 3)^2  =>  10 = k * (33-3)^2  => k = 1/90
# Target P for a given n: P = 3 + sqrt(90 * n)

dt_valid <- dt_summary[normalized_momentum <= 50 & node_count <= 10]

# For each node count, calculate the target P and find the closest actual row
dt_representatives <- dt_valid[, {
  target_p <- 3 + sqrt(90 * node_count)
  .SD[which.min(abs(normalized_momentum - target_p))]
}, by = node_count]

# Flag for highlighting
dt_summary[, is_selected := FALSE]
dt_summary[normalized_momentum %in% dt_representatives$normalized_momentum, is_selected := TRUE]
```

```{r summary-plot, echo=FALSE, fig.width=12, fig.height=8, warning=FALSE}
# Plot displays only the valid range P <= 50
dt_plot <- dt_valid

# --- TEXTBOOK PARABOLA CONSTRUCTION ---
# We draw the ideal line so the user can see how close the selected points are.
p_range <- seq(0, 50, length.out = 200)
pred_data <- data.table(normalized_momentum = p_range)
pred_data[, node_count := (1/90) * (normalized_momentum - 3)^2]
# Filter to positive branch (P >= 3) and valid node counts
pred_data <- pred_data[node_count >= 0 & normalized_momentum >= 3]

ggplot(dt_plot, aes(x = normalized_momentum, y = node_count)) +
  # Background: Valid scanned data points (P <= 50)
  geom_point(color = "black", size = 1.0, alpha = 0.05, na.rm = TRUE) +
  
  # The "Textbook Parabola" (Green Line)
  geom_line(data = pred_data, aes(y = node_count), 
            color = "forestgreen", linetype = "dashed", size = 1.5, alpha = 0.9) +
  
  # Foreground: The Closest-Match points in red
  geom_point(data = dt_representatives, 
             color = "red", size = 3) +
  
  # --- AXES ---
  scale_x_continuous(limits = c(0, 50)) +
  scale_y_continuous(limits = c(0, 10), breaks = seq(0, 10, by = 1)) +
  labs(
    title = "Detected Nodes vs. Momentum (Parabola-Matched Selection)",
    subtitle = "Red dots: Experimental data points closest to the ideal Green Line (Vertex P=3, Rim P=33).",
    x = "Momentum P", y = "Node Count n"
  ) +
  theme_minimal() +
  theme(panel.grid.minor.y = element_blank())
```

---

## 2. Representative Diagnostic Scans (Parabola Matches)

```{r diagnostic-scan, echo=FALSE, results='asis', fig.width=8, fig.height=4}
# Sort sequentially for the report flow
setorder(dt_representatives, node_count)

for (i in seq_len(nrow(dt_representatives))) {
  p_val  <- dt_representatives$normalized_momentum[i]
  n_val  <- dt_representatives$node_count[i]
  p_str  <- sprintf("%013.6f", p_val)
  
  d_path <- file.path(agg_dir, sprintf("erasure_distance_density_P_%s.csv.gz", p_str))
  n_path <- file.path(nodes_dir, sprintf("erasure_distance_nodes_P_%s.csv.gz", p_str))
  
  if (file.exists(d_path)) {
    h_pts <- data.table::fread(d_path)
    n_pts <- if(file.exists(n_path)) data.table::fread(n_path)[!is.na(coordinate_q)] else data.table::data.table()
    
    bw <- 1.0
    
    p <- ggplot(h_pts, aes(coordinate_q, density_count)) +
      geom_col(fill = "black", alpha = 0.3, width = bw) +
      geom_step(direction = "mid", color = "black", linewidth = 0.3) +
      coord_cartesian(xlim = c(-p_val, p_val)) +
      labs(title = sprintf("Node Count: %d (Closest to Parabola)", n_val),
           subtitle = sprintf("P = %f | Fixed Bin Width = %.1f", p_val, bw),
           x = "q", y = "Occupancy") +
      theme_minimal(base_family = "mono")
    
    if (nrow(n_pts) > 0) {
      p <- p + geom_point(data = n_pts, aes(coordinate_q, density_count), color = "red", size = 2)
    }
    
    cat("\n\n### Node Count:", n_val, " (P =", p_val, ")\n")
    print(p)
    cat("\n\n---\n\n")
  }
}
```
