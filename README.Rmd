---
title: "Stern-Brocot Physics: QHO Parabolic Ridge (P=20 Focus)"
output:
  github_document: default
---

# Stern-Brocot Physics: Parabolic Curve Alignment

---

## 1. Summary: Node Count vs. Momentum

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(fig.showtext = TRUE, dpi = 300)
library(ggplot2)
library(data.table)
```

```{r parabolic-selection, echo=F, message=F}
# Path Configuration
base_dir     <- "/Volumes/SanDisk4TB/SternBrocot-data"
summary_path <- file.path(base_dir, "04_erasure_distance_summary.csv.gz")
agg_dir      <- file.path(base_dir, "02_erasure_distance_densities")
nodes_dir    <- file.path(base_dir, "03_erasure_distance_density_nodes")

# Load and Filter Data
dt_summary <- data.table::fread(summary_path)
dt_plot <- dt_summary[normalized_momentum <= 30]

# --- QHO Parabolic Parameters ---
# Model: n = k * P^2 + offset
k_val <- 0.0325
offset <- -0.5

# --- Selection Logic (n=0 to 10) ---
# Find the point for each node count that minimizes distance to the theoretical parabola
dt_representatives <- dt_plot[node_count %in% 0:10][
  order(abs(normalized_momentum - sqrt((node_count - offset) / k_val)))
][, .SD[1], by = node_count]

# Flag for highlighting
dt_plot[, is_selected := (normalized_momentum %in% dt_representatives$normalized_momentum)]

# Save the representatives to your Desktop
fwrite(dt_representatives, "~/Desktop/stern_brocot_qho_representatives_focus.csv")
```

> **Data Exported**: Selected QHO states for $n \in [0, 10]$ saved to `~/Desktop/stern_brocot_qho_representatives_focus.csv`.

```{r summary-plot, echo=FALSE, fig.width=12, fig.height=6, warning=FALSE}
ggplot(dt_plot, aes(x = normalized_momentum, y = node_count)) +
  # Background: All scanned data points
  geom_point(color = "black", size = 1.0, alpha = 0.05, na.rm = TRUE) +
  # The QHO Parabolic Curve
  stat_function(fun = function(x) k_val * x^2 + offset, 
                color = "blue", linewidth = 1, alpha = 0.6) +
  # The Selected Representative States
  geom_point(data = dt_plot[is_selected == TRUE], 
             color = "red", size = 3) +
  # --- UPDATED AXES: Limited at P=20 and n=10 ---
  coord_cartesian(xlim = c(0, 20), ylim = c(0, 10)) +
  scale_y_continuous(breaks = 0:10) + 
  labs(
    title = "Node Count vs. Momentum: QHO Ridge Focus (P=20)",
    subtitle = "Blue curve: n = 0.0325 * P² - 0.5. Red dots: Closest physical matches.",
    x = "Momentum P", y = "Node Count n"
  ) +
  theme_minimal()
```

---

## 2. Diagnostic Scans (n=0 to n=10)

```{r diagnostic-scan, echo=FALSE, results='asis', fig.width=8, fig.height=4}
setorder(dt_representatives, node_count)

for (i in seq_len(nrow(dt_representatives))) {
  p_val  <- dt_representatives$normalized_momentum[i]
  n_val  <- dt_representatives$node_count[i]
  p_str  <- sprintf("%013.6f", p_val)
  
  d_path <- file.path(agg_dir, sprintf("erasure_distance_density_P_%s.csv.gz", p_str))
  n_path <- file.path(nodes_dir, sprintf("erasure_distance_nodes_P_%s.csv.gz", p_str))
  
  if (file.exists(d_path)) {
    h_pts <- data.table::fread(d_path)
    n_pts <- if(file.exists(n_path)) data.table::fread(n_path)[!is.na(coordinate_q)] else data.table::data.table()
    bw <- if(nrow(h_pts) > 1) diff(h_pts$coordinate_q[1:2]) else 0.1
    
    p <- ggplot(h_pts, aes(coordinate_q, density_count)) +
      geom_col(fill = "black", alpha = 0.2, width = bw) +
      geom_step(direction = "mid", color = "black", linewidth = 0.3) +
      coord_cartesian(xlim = c(-p_val, p_val)) +
      labs(title = sprintf("Node Count: %d (QHO Parabola Aligned)", n_val),
           subtitle = sprintf("P = %f (Theoretical P ≈ %.3f)", p_val, sqrt((n_val - offset)/k_val)),
           x = "q", y = "Occupancy") +
      theme_minimal(base_family = "mono")
    
    if (nrow(n_pts) > 0) {
      p <- p + geom_point(data = n_pts, aes(coordinate_q, density_count), color = "red", size = 2)
    }
    
    cat("\n\n### Node Count:", n_val, " (P =", p_val, ")\n")
    print(p)
    cat("\n\n---\n\n")
  }
}
```
