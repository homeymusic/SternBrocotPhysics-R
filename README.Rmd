---
title: "Stern-Brocot Physics"
output:
  github_document: default
---

# Stern-Brocot Physics

![Violating Bell's Theorem](man/figures/hero_bell.png)

---

```{r ideal-state-selector, echo=FALSE, results='asis', fig.width=12, fig.height=8}
library(data.table)
library(ggplot2)

base_dir    <- "/Volumes/SanDisk4TB/SternBrocot-data"
density_dir <- file.path(base_dir, "02_erasure_distance_densities")
nodes_dir   <- file.path(base_dir, "03_erasure_distance_density_nodes")
summary_path <- file.path(base_dir, "04_erasure_distance_summary.csv.gz")

dt_summary <- fread(summary_path)

# --- DYNAMIC SELECTION LOGIC ---
available_nodes <- sort(unique(dt_summary$node_count[!is.na(dt_summary$node_count)]))
dt_max_variation <- data.table()

for (val_n in available_nodes) {
  if (val_n == 0) {
    # FORCE GROUND STATE TO P=0.5
    ground_state <- dt_summary[abs(normalized_momentum - 0.5) < 1e-6]
    if (nrow(ground_state) > 0) {
      dt_max_variation <- rbind(dt_max_variation, ground_state[1])
    }
  } else {
    candidates <- dt_summary[node_count == val_n]
    if (nrow(candidates) > 0) {
      max_variation <- candidates[which.max(complexity_ntv)]
      dt_max_variation <- rbind(dt_max_variation, max_variation)
    }
  }
}

max_n <- max(dt_summary$node_count, na.rm = TRUE)
max_q <- max(dt_summary$normalized_momentum, na.rm = TRUE)

# --- PLOT 1: OVERVIEW ---
p_ov_action <- ggplot() +
  geom_point(data = dt_summary[order(complexity_ntv)], 
             aes(x = normalized_momentum, y = node_count, color = complexity_ntv), 
             size = 1.5, alpha = 0.6) +
  scale_color_viridis_c(option = "magma", name = "Variation") +
  
  # Selection Markers with white halo for visibility on white background
  geom_point(data = dt_max_variation, aes(x = normalized_momentum, y = node_count), 
             color = "white", size = 5.5, shape = 21, stroke = 1.5) +
  geom_point(data = dt_max_variation, aes(x = normalized_momentum, y = node_count), 
             color = "gray", size = 5, shape = 21, fill = NA, stroke = 1.2) +
             
  geom_text(data = dt_max_variation, aes(x = normalized_momentum, y = node_count, 
            label = sprintf("n=%d\nNTV=%.2f", node_count, complexity_ntv)),
            nudge_y = 0.8, size = 2.5, fontface = "bold", lineheight = 0.9) +
            
  labs(title = "Node Count and Momentum",
       subtitle = "Maximum Variation Density Distributions are Highlighted", 
       x = "Coordinate (Q)", y = "Nodes (n)") +
  scale_x_continuous(limits = c(0, max_q)) + 
  scale_y_continuous(breaks = seq(0, max_n, by = 1), 
                     minor_breaks = NULL, 
                     expand = expansion(mult = c(0.05, 0.1))) +
  theme_minimal() +
  theme(panel.grid.minor.y = element_blank())

print(p_ov_action)
cat("\n\n---\n\n")

# --- PLOT 2: PROFILES (Synchronized with Animation Labels) ---
render_profiles <- function(matches_dt, dot_color = "black") {
  for (i in seq_len(nrow(matches_dt))) {
    row <- matches_dt[i]
    q_val <- row$normalized_momentum
    
    q_str <- sprintf("%0.6f", q_val)
    d_path <- file.path(density_dir, sprintf("erasure_distance_density_P_%s.csv.gz", q_str))
    if (!file.exists(d_path)) d_path <- file.path(density_dir, sprintf("erasure_distance_density_P_%013.6f.csv.gz", q_val))
    n_path <- file.path(nodes_dir, sprintf("erasure_distance_nodes_P_%s.csv.gz", q_str))
    if (!file.exists(n_path)) n_path <- file.path(nodes_dir, sprintf("erasure_distance_nodes_P_%013.6f.csv.gz", q_val))

    if (file.exists(d_path)) {
      h_pts <- fread(d_path)
      first_nz <- which(h_pts$density_count > 0)[1]
      last_nz  <- rev(which(h_pts$density_count > 0))[1]
      if (is.na(first_nz)) next
      dt_active <- h_pts[first_nz:last_nz]

      max_h <- max(dt_active$density_count, na.rm = TRUE)
      q_diff_raw <- if(nrow(dt_active) > 1) median(diff(dt_active$coordinate_q), na.rm=TRUE) else 1.0
      max_q_edge <- max(abs(dt_active$coordinate_q), na.rm = TRUE) + (q_diff_raw / 2)
      
      # SYNCED LABEL LOGIC FROM YOUR ANIMATION CODE
      plot_title <- sprintf("Nodes: %02d  |  Momentum: %3.3f  | Max Amplitude: %4.1f  |  Max Density: %6s",
                            row$node_count, q_val, max_q_edge, format(max_h, big.mark=","))

      dt_active[, `:=`(pct_density = (density_count/max_h)*100, pct_q = (coordinate_q/max_q_edge)*100)]
      pct_width <- (q_diff_raw / max_q_edge) * 100
      
      pad_l <- data.table(pct_q = min(dt_active$pct_q) - pct_width, pct_density = 0)
      pad_r <- data.table(pct_q = max(dt_active$pct_q) + pct_width, pct_density = 0)
      h_plot_data <- rbind(pad_l, dt_active[, .(pct_q, pct_density)], pad_r)

      n_pts <- if(file.exists(n_path)) fread(n_path) else data.table()
      if (nrow(n_pts) > 0 && "coordinate_q" %in% names(n_pts)) {
        n_pts <- n_pts[!is.na(coordinate_q)]
        n_pts[, `:=`(pct_density = (density_count/max_h)*100, pct_q = (coordinate_q/max_q_edge)*100)]
      }
      
      p <- ggplot() +
        geom_col(data = dt_active, aes(x = pct_q, y = pct_density), width = pct_width, fill = "grey85") +
        geom_step(data = h_plot_data, aes(x = pct_q, y = pct_density), color = "black", linewidth = 0.7, direction = "mid") + 
        geom_point(data = n_pts, aes(x = pct_q, y = pct_density), color = dot_color, size = 3) +
        geom_vline(xintercept = 0, linetype = "dashed", color = "grey70", linewidth = 0.5) +
        labs(title = plot_title, x = "Amplitude (%)", y = "Density %") +
        coord_cartesian(xlim = c(-100, 100), ylim = c(0, 105)) +
        scale_x_continuous(breaks = seq(-100, 100, 50)) +
        scale_y_continuous(expand = c(0, 0)) +
        theme_minimal() +
        theme(plot.title = element_text(family = "mono", face = "bold", size = 11), panel.grid.minor = element_blank())
      
      print(p)
      cat("\n\n---\n\n")
    }
  }
}
render_profiles(dt_max_variation, "black")
```
